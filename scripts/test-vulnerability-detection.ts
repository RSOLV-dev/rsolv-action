#!/usr/bin/env ts-node

/**
 * Test script to verify if RSOLV vulnerability detection is actually working
 * Tests the complete flow from RSOLV-action to RSOLV-api
 */

const axios = require('axios');
const crypto = require('crypto');

const API_URL = 'http://localhost:4001'; // Force local instance
const API_KEY = process.env.RSOLV_API_KEY || 'rsolv_test_abc123';

// Vulnerable code samples for testing
const VULNERABLE_CODE_SAMPLES = {
  javascript: {
    sqlInjection: `
      // SQL Injection vulnerability
      const userId = req.params.id;
      const query = "SELECT * FROM users WHERE id = " + userId;
      db.query(query, (err, results) => {
        res.json(results);
      });
    `,
    xss: `
      // XSS vulnerability
      const userInput = req.query.name;
      document.getElementById('output').innerHTML = userInput;
    `,
    commandInjection: `
      // Command injection vulnerability
      const filename = req.query.file;
      const { exec } = require('child_process');
      exec('cat ' + filename, (err, stdout) => {
        res.send(stdout);
      });
    `
  },
  python: {
    sqlInjection: `
# SQL Injection vulnerability
user_id = request.args.get('id')
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)
    `,
    commandInjection: `
# Command injection vulnerability
import os
filename = request.args.get('file')
os.system(f"cat {filename}")
    `
  }
};

interface EncryptionResult {
  encryptedContent: string;
  iv: string;
  authTag: string;
  key: Buffer;
}

function encryptContent(content: string): EncryptionResult {
  const key = crypto.randomBytes(32); // AES-256 key
  const iv = crypto.randomBytes(16);
  
  const cipher = crypto.createCipheriv('aes-256-gcm', key, iv);
  let encrypted = cipher.update(content, 'utf8');
  encrypted = Buffer.concat([encrypted, cipher.final()]);
  const authTag = cipher.getAuthTag();
  
  return {
    encryptedContent: encrypted.toString('base64'),
    iv: iv.toString('base64'),
    authTag: authTag.toString('base64'),
    key
  };
}

async function testPatternAPI() {
  console.log('üîç Testing Pattern API...\n');
  
  try {
    // Test public patterns (no auth)
    const publicResponse = await axios.get(`${API_URL}/api/v1/patterns/javascript`);
    console.log(`‚úÖ Public patterns accessible: ${publicResponse.data.patterns?.length || 0} patterns`);
    
    // Test authenticated patterns
    const authResponse = await axios.get(`${API_URL}/api/v1/patterns/javascript`, {
      headers: { 'Authorization': `Bearer ${API_KEY}` }
    });
    console.log(`‚úÖ Authenticated patterns: ${authResponse.data.patterns?.length || 0} patterns`);
    
    // Check pattern format
    if (authResponse.data.patterns?.length > 0) {
      const pattern = authResponse.data.patterns[0];
      console.log('\nüìã Pattern format sample:');
      console.log(JSON.stringify(pattern, null, 2).substring(0, 500) + '...');
    }
  } catch (error: any) {
    console.error(`‚ùå Pattern API test failed: ${error.message}`);
  }
}

async function testASTAnalysis() {
  console.log('\nüîç Testing AST Analysis Endpoint...\n');
  
  const testCases = [
    { language: 'javascript', code: VULNERABLE_CODE_SAMPLES.javascript.sqlInjection, name: 'SQL Injection' },
    { language: 'javascript', code: VULNERABLE_CODE_SAMPLES.javascript.xss, name: 'XSS' },
    { language: 'javascript', code: VULNERABLE_CODE_SAMPLES.javascript.commandInjection, name: 'Command Injection' },
    { language: 'python', code: VULNERABLE_CODE_SAMPLES.python.sqlInjection, name: 'Python SQL Injection' }
  ];
  
  for (const testCase of testCases) {
    console.log(`\nüìù Testing ${testCase.name} detection...`);
    
    try {
      // Encrypt the code
      const encryption = encryptContent(testCase.code);
      
      // Prepare request
      const request = {
        requestId: `test-${Date.now()}`,
        files: [{
          path: `test.${testCase.language === 'javascript' ? 'js' : 'py'}`,
          encryptedContent: encryption.encryptedContent,
          encryption: {
            iv: encryption.iv,
            authTag: encryption.authTag,
            algorithm: 'aes-256-gcm'
          },
          metadata: {
            language: testCase.language,
            size: Buffer.byteLength(testCase.code),
            contentHash: crypto.createHash('sha256').update(testCase.code).digest('hex')
          }
        }],
        options: {
          patternFormat: 'enhanced',
          includeSecurityPatterns: true
        }
      };
      
      // Make request
      const response = await axios.post(`${API_URL}/api/v1/ast/analyze`, request, {
        headers: {
          'X-API-Key': API_KEY,
          'X-Encryption-Key': encryption.key.toString('base64'),
          'Content-Type': 'application/json'
        }
      });
      
      // Check results
      const result = response.data.results[0];
      if (result.status === 'success') {
        if (result.findings.length > 0) {
          console.log(`‚úÖ Vulnerabilities detected: ${result.findings.length}`);
          result.findings.forEach((finding: any) => {
            console.log(`   - ${finding.patternName} (${finding.severity}) at line ${finding.location.startLine}`);
            console.log(`     Confidence: ${(finding.confidence * 100).toFixed(0)}%`);
          });
        } else {
          console.log(`‚ùå No vulnerabilities detected (expected to find some)`);
        }
      } else {
        console.log(`‚ùå Analysis failed: ${result.error?.message || 'Unknown error'}`);
      }
    } catch (error: any) {
      console.error(`‚ùå AST analysis test failed: ${error.response?.data?.error?.message || error.message}`);
      if (error.response?.data) {
        console.error('Response:', JSON.stringify(error.response.data, null, 2));
      }
    }
  }
}

async function testSafeCode() {
  console.log('\nüîç Testing Safe Code (should not detect vulnerabilities)...\n');
  
  const safeCode = `
    // Safe parameterized query
    const userId = req.params.id;
    const query = "SELECT * FROM users WHERE id = ?";
    db.query(query, [userId], (err, results) => {
      res.json(results);
    });
    
    // Safe text content setting
    const userInput = req.query.name;
    document.getElementById('output').textContent = userInput;
  `;
  
  try {
    const encryption = encryptContent(safeCode);
    
    const request = {
      requestId: `test-safe-${Date.now()}`,
      files: [{
        path: 'safe.js',
        encryptedContent: encryption.encryptedContent,
        encryption: {
          iv: encryption.iv,
          authTag: encryption.authTag,
          algorithm: 'aes-256-gcm'
        },
        metadata: {
          language: 'javascript',
          size: Buffer.byteLength(safeCode),
          contentHash: crypto.createHash('sha256').update(safeCode).digest('hex')
        }
      }],
      options: {
        patternFormat: 'enhanced',
        includeSecurityPatterns: true
      }
    };
    
    const response = await axios.post(`${API_URL}/api/v1/ast/analyze`, request, {
      headers: {
        'X-API-Key': API_KEY,
        'X-Encryption-Key': encryption.key.toString('base64'),
        'Content-Type': 'application/json'
      }
    });
    
    const result = response.data.results[0];
    if (result.status === 'success') {
      if (result.findings.length === 0) {
        console.log(`‚úÖ Correctly identified safe code (no vulnerabilities)`);
      } else {
        console.log(`‚ö†Ô∏è  False positives detected: ${result.findings.length}`);
        result.findings.forEach((finding: any) => {
          console.log(`   - ${finding.patternName} at line ${finding.location.startLine}`);
        });
      }
    }
  } catch (error: any) {
    console.error(`‚ùå Safe code test failed: ${error.message}`);
  }
}

async function main() {
  console.log('üöÄ RSOLV Vulnerability Detection Verification\n');
  console.log(`API URL: ${API_URL}`);
  console.log(`API Key: ${API_KEY.substring(0, 10)}...`);
  console.log('=' .repeat(50));
  
  // Run tests
  await testPatternAPI();
  await testASTAnalysis();
  await testSafeCode();
  
  console.log('\n' + '=' .repeat(50));
  console.log('‚úÖ Verification complete\n');
}

// Handle missing dependencies
try {
  require('axios');
} catch (e) {
  console.error('Please install dependencies: npm install axios typescript ts-node @types/node');
  process.exit(1);
}

main().catch(console.error);