name: Test Vended Credentials with CLI

on:
  workflow_dispatch:
  push:
    branches:
      - feature/test-aware-fix-validation

jobs:
  test-cli-auth:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false  # Skip submodules to avoid nodegoat-demo issue

      - name: Checkout RSOLV-action submodule only
        run: |
          git submodule update --init RSOLV-action

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install RSOLV-action dependencies
        run: |
          cd RSOLV-action
          bun install --frozen-lockfile

      - name: Build RSOLV-action
        run: |
          cd RSOLV-action
          bun run build

      - name: Test CLI Selection and Authentication
        env:
          RSOLV_API_KEY: ${{ secrets.RSOLV_API_KEY }}
          RSOLV_AI_PROVIDER: claude-code
          RSOLV_USE_VENDED_CREDENTIALS: "true"
          RSOLV_DEBUG: "true"
        run: |
          cd RSOLV-action

          echo "=== Testing Config Loading ==="
          node -e "
          const { loadConfig } = require('./dist/config/index.js');
          loadConfig().then(config => {
            console.log('AI Provider:', config.aiProvider);
            console.log('Use Vended Credentials:', config.aiProvider.useVendedCredentials);
            console.log('Model:', config.aiProvider.model);

            if (config.aiProvider.useVendedCredentials !== true) {
              console.error('ERROR: useVendedCredentials should be true!');
              process.exit(1);
            }

            if (config.aiProvider.model !== 'claude-sonnet-4-20250514') {
              console.error('ERROR: Model should be claude-sonnet-4-20250514!');
              process.exit(1);
            }
          });
          "

          echo ""
          echo "=== Testing Adapter Selection ==="
          # Create a minimal test to verify CLI adapter is selected
          node -e "
          const { ClaudeCodeGitAdapter } = require('./dist/ai/adapters/claude-code-git.js');
          const { loadConfig } = require('./dist/config/index.js');

          loadConfig().then(async config => {
            const adapter = new ClaudeCodeGitAdapter(config);
            await adapter.initialize();

            // The adapter logs which implementation it's using
            console.log('Adapter initialized successfully');

            // Check if CLI would be selected
            const useCLI = process.env.RSOLV_USE_CLI === 'true' ||
                          config.claudeConfig?.useStructuredPhases ||
                          config.aiProvider.useVendedCredentials;

            console.log('CLI should be selected:', useCLI);

            if (!useCLI) {
              console.error('ERROR: CLI adapter should be selected with vended credentials!');
              process.exit(1);
            }
          });
          "