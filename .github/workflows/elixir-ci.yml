name: Elixir/Phoenix CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual triggering

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.18.1"
  OTP_VERSION: "27.2"

jobs:
  # Job 1: Run Elixir test suite
  test:
    name: Test Suite (Elixir ${{matrix.elixir}} / OTP ${{matrix.otp}})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        elixir: ["1.18.1"]
        otp: ["27.2"]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rsolv_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/rsolv_test
      SECRET_KEY_BASE: test-secret-key-base-at-least-64-chars-long-abcdefghijklmnopqrstuvwxyz0123456789
      # Mock API keys for tests (don't make real API calls in CI)
      ANTHROPIC_API_KEY: mock_test_key_anthropic_at_least_32_characters
      OPENAI_API_KEY: mock_test_key_openai_at_least_32_characters

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false # Skip submodules for faster checkout

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile dependencies
        run: mix deps.compile

      - name: Compile application
        run: mix compile --warnings-as-errors

      - name: Create and migrate test database
        run: |
          mix ecto.create
          mix ecto.migrate

      - name: Run tests
        run: mix test --trace

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-elixir-${{ matrix.elixir }}-otp-${{ matrix.otp }}
          path: |
            _build/test/lib/rsolv/test-results.xml
          if-no-files-found: ignore

  # Job 2: OpenAPI Spec Validation (CRITICAL!)
  openapi-validation:
    name: OpenAPI Spec Validation
    runs-on: ubuntu-latest

    env:
      MIX_ENV: dev # OpenAPI generation typically runs in dev
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/rsolv_dev
      SECRET_KEY_BASE: dev-secret-key-base-at-least-64-chars-long-abcdefghijklmnopqrstuvwxyz0123456789

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rsolv_dev
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-openapi-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-openapi-

      - name: Install dependencies
        run: mix deps.get

      - name: Create and migrate database
        run: |
          mix ecto.create
          mix ecto.migrate

      - name: Generate OpenAPI spec
        run: |
          echo "=== Generating OpenAPI specification ==="
          mix rsolv.openapi priv/static/openapi.json

      - name: Validate OpenAPI spec
        run: |
          echo "=== Validating OpenAPI spec ==="

          # Check that file was generated
          if [ ! -f priv/static/openapi.json ]; then
            echo "ERROR: OpenAPI spec file not generated!"
            exit 1
          fi

          # Check file size (should be > 100KB)
          FILE_SIZE=$(stat -c%s priv/static/openapi.json)
          if [ "$FILE_SIZE" -lt 102400 ]; then
            echo "ERROR: OpenAPI spec file is too small ($FILE_SIZE bytes). Expected > 100KB."
            exit 1
          fi

          echo "âœ… OpenAPI spec file size: $FILE_SIZE bytes"

          # Validate JSON format
          if ! jq empty priv/static/openapi.json 2>/dev/null; then
            echo "ERROR: OpenAPI spec is not valid JSON!"
            exit 1
          fi

          echo "âœ… OpenAPI spec is valid JSON"

          # Count paths (should be 25+)
          PATH_COUNT=$(jq '.paths | length' priv/static/openapi.json)
          if [ "$PATH_COUNT" -lt 25 ]; then
            echo "ERROR: Expected at least 25 API paths, found only $PATH_COUNT"
            exit 1
          fi

          echo "âœ… OpenAPI spec contains $PATH_COUNT API paths"

          # Verify OpenAPI version
          OPENAPI_VERSION=$(jq -r '.openapi' priv/static/openapi.json)
          echo "âœ… OpenAPI version: $OPENAPI_VERSION"

          # Verify info section
          API_TITLE=$(jq -r '.info.title' priv/static/openapi.json)
          API_VERSION=$(jq -r '.info.version' priv/static/openapi.json)
          echo "âœ… API Title: $API_TITLE"
          echo "âœ… API Version: $API_VERSION"

          echo ""
          echo "=== OpenAPI Spec Validation Complete ==="

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: priv/static/openapi.json

  # Job 3: Code Quality Checks
  code-quality:
    name: Code Quality (Format & Warnings)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-quality-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-quality-

      - name: Install dependencies
        run: mix deps.get

      - name: Check code formatting
        run: |
          echo "=== Checking Elixir code formatting ==="
          mix format --check-formatted
          echo "âœ… Code formatting check passed"

      - name: Compile with warnings as errors
        run: |
          echo "=== Compiling with warnings as errors ==="
          mix compile --warnings-as-errors
          echo "âœ… Compilation successful with no warnings"

  # Job 4: Database Migration Verification
  migrations:
    name: Migration Integrity
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/rsolv_migration_test
      SECRET_KEY_BASE: test-secret-key-base-at-least-64-chars-long-abcdefghijklmnopqrstuvwxyz0123456789

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rsolv_migration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-migrations-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-migrations-

      - name: Install dependencies
        run: mix deps.get

      - name: Create database
        run: mix ecto.create

      - name: Run migrations (up)
        run: |
          echo "=== Running all migrations UP ==="
          mix ecto.migrate
          echo "âœ… All migrations applied successfully"

      - name: Get migration count
        run: |
          MIGRATION_COUNT=$(mix ecto.migrations | grep -c "up" || true)
          echo "Total migrations applied: $MIGRATION_COUNT"

      - name: Rollback all migrations
        run: |
          echo "=== Rolling back all migrations ==="
          mix ecto.rollback --all
          echo "âœ… All migrations rolled back successfully"

      - name: Re-run migrations (verify idempotency)
        run: |
          echo "=== Re-running all migrations UP ==="
          mix ecto.migrate
          echo "âœ… Migrations are idempotent and reversible"

      - name: Run seeds
        run: |
          echo "=== Running database seeds ==="
          mix run priv/repo/seeds.exs
          echo "âœ… Database seeds executed successfully"

  # Job 5: Asset Compilation
  assets:
    name: Asset Compilation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: assets/package-lock.json

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-assets-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-assets-

      - name: Install Elixir dependencies
        run: mix deps.get

      - name: Install Node.js dependencies
        run: |
          if [ -f "assets/package.json" ]; then
            cd assets && npm ci
          else
            echo "No assets/package.json found, skipping npm install"
          fi

      - name: Setup assets
        run: |
          echo "=== Setting up asset build tools ==="
          mix assets.setup
          echo "âœ… Asset tools installed"

      - name: Build assets
        run: |
          echo "=== Building assets ==="
          mix assets.build
          echo "âœ… Assets compiled successfully"

      - name: Verify assets directory
        run: |
          echo "=== Verifying assets output ==="
          if [ -d "priv/static/assets" ]; then
            echo "âœ… Assets directory created"
            ls -lh priv/static/assets/ | head -20
          else
            echo "WARNING: Assets directory not found at priv/static/assets"
            echo "Checking for alternative locations..."
            find priv/static -type d -name "assets" || true
          fi

  # Summary job - only runs if all jobs succeed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test, openapi-validation, code-quality, migrations, assets]
    if: success()

    steps:
      - name: All checks passed
        run: |
          echo "============================================"
          echo "âœ… All CI checks passed successfully!"
          echo "============================================"
          echo ""
          echo "Completed jobs:"
          echo "  âœ… Test Suite"
          echo "  âœ… OpenAPI Spec Validation"
          echo "  âœ… Code Quality"
          echo "  âœ… Migration Integrity"
          echo "  âœ… Asset Compilation"
          echo ""
          echo "Ready to merge! ðŸš€"
