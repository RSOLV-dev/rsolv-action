version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rsolv_dev
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  rsolv-api-no-volumes:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - "4002:4000"
    environment:
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/rsolv_dev"
      MIX_ENV: dev
      RSOLV_API_HOST: localhost
      RSOLV_ACTION_URL: http://rsolv-action:3333
      SECRET_KEY_BASE: "test-secret-key-base-must-be-at-least-64-bytes-long-for-phoenix-framework"
      ENCRYPTION_KEY: "test-encryption-key-32-bytes-ok"
      PHX_SERVER: "true"
    depends_on:
      postgres:
        condition: service_healthy
    # NO VOLUME MOUNTS - using the compiled code from the image