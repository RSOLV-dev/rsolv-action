defmodule RsolvWeb.Api.V1.VulnerabilityValidationRouter do
  @moduledoc """
  Router module that selects the appropriate validation controller based on feature flag.
  Allows gradual rollout of the new false positive caching system.
  """
  
  use RsolvWeb, :controller
  
  alias FunWithFlags, as: Flags
  alias RsolvWeb.Api.V1.VulnerabilityValidationController
  alias RsolvWeb.Api.V1.VulnerabilityValidationControllerWithCache
  
  require Logger
  
  def validate(conn, params) do
    Logger.info("ðŸš€ [Router Debug] Received validation request")
    # Check for environment variable override first (for staging testing)
    use_cache = cond do
      System.get_env("FORCE_CACHE_CONTROLLER") == "true" ->
        Logger.debug("Using cached validation controller (forced via env var)")
        true
        
      System.get_env("FORCE_CACHE_CONTROLLER") == "false" ->
        Logger.debug("Using standard validation controller (forced via env var)")
        false
        
      true ->
        # Check if the false positive caching feature is enabled
        case Flags.enabled?(:false_positive_caching) do
          {:ok, true} ->
            Logger.debug("Using cached validation controller (via feature flag)")
            true
            
          _ ->
            Logger.debug("Using standard validation controller (feature flag disabled)")
            false
        end
    end
    
    if use_cache do
      Logger.info("ðŸŽ¯ [Router Debug] Routing to VulnerabilityValidationControllerWithCache")
      VulnerabilityValidationControllerWithCache.validate(conn, params)
    else
      Logger.info("ðŸŽ¯ [Router Debug] Routing to VulnerabilityValidationController")
      VulnerabilityValidationController.validate(conn, params)
    end
  end
end