defmodule RsolvWeb.Schemas.Vulnerability do
  @moduledoc """
  OpenAPI schemas for vulnerability validation endpoints.
  """

  alias OpenApiSpex.Schema

  defmodule VulnerabilityValidateRequest do
    @moduledoc """
    Vulnerability validation request for AST-based false positive reduction

    ## Examples

    ### Single SQL Injection Validation (High Confidence True Positive)
    ```json
    {
      "vulnerabilities": [{
        "id": "vuln_sql_001",
        "type": "sql_injection",
        "severity": "high",
        "file": "src/controllers/user.js",
        "line": 42,
        "code": "const query = 'SELECT * FROM users WHERE id = ' + userId;",
        "message": "SQL query built using string concatenation"
      }],
      "files": {
        "src/controllers/user.js": "const userId = req.params.id;\\nconst query = 'SELECT * FROM users WHERE id = ' + userId;\\ndb.query(query);"
      }
    }
    ```

    ### Multiple Vulnerabilities with False Positives
    ```json
    {
      "vulnerabilities": [
        {
          "id": "vuln_xss_001",
          "type": "xss",
          "severity": "medium",
          "file": "src/views/profile.js",
          "line": 15,
          "code": "element.innerHTML = userInput;",
          "message": "Unsafe innerHTML assignment"
        },
        {
          "id": "vuln_xss_002",
          "type": "xss",
          "severity": "medium",
          "file": "test/profile.test.js",
          "line": 22,
          "code": "element.innerHTML = '<div>test</div>';",
          "message": "Unsafe innerHTML assignment"
        }
      ],
      "files": {
        "src/views/profile.js": "const userInput = req.body.bio;\\nelement.innerHTML = userInput;",
        "test/profile.test.js": "it('renders div', () => {\\n  element.innerHTML = '<div>test</div>';\\n  expect(element.innerHTML).toContain('test');\\n});"
      }
    }
    ```

    ### Path Traversal with Validation Detection
    ```json
    {
      "vulnerabilities": [{
        "id": "vuln_path_001",
        "type": "path_traversal",
        "severity": "high",
        "file": "src/files/download.js",
        "line": 10,
        "code": "const filePath = path.join(baseDir, fileName);",
        "message": "Potential path traversal vulnerability"
      }],
      "files": {
        "src/files/download.js": "const fileName = sanitizePath(req.query.file);\\nconst filePath = path.join(baseDir, fileName);\\nfs.readFile(filePath);"
      }
    }
    ```

    ### Command Injection in Different Languages
    ```json
    {
      "vulnerabilities": [
        {
          "id": "vuln_cmd_py_001",
          "type": "command_injection",
          "severity": "critical",
          "file": "app/utils.py",
          "line": 25,
          "code": "os.system(f'ping {host}')",
          "message": "Command injection via os.system"
        },
        {
          "id": "vuln_cmd_rb_001",
          "type": "command_injection",
          "severity": "critical",
          "file": "lib/network.rb",
          "line": 18,
          "code": "system('ping ' + host)",
          "message": "Command injection via system call"
        }
      ],
      "files": {
        "app/utils.py": "def ping_host(host):\\n    # UNSAFE\\n    os.system(f'ping {host}')",
        "lib/network.rb": "def ping_host(host)\\n  # UNSAFE\\n  system('ping ' + host)\\nend"
      }
    }
    ```

    ## Client Code Examples

    ### JavaScript (Node.js)
    ```javascript
    const axios = require('axios');

    async function validateVulnerabilities(vulnerabilities, files, apiKey) {
      const response = await axios.post(
        'https://api.rsolv.dev/api/v1/vulnerabilities/validate',
        {
          vulnerabilities: vulnerabilities.map(v => ({
            id: v.id,
            type: v.type,
            severity: v.severity,
            file: v.file,
            line: v.line,
            code: v.code,
            message: v.message
          })),
          files: files
        },
        {
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
        }
      );

      // Filter to only true positives
      const truePositives = response.data.validated.filter(v => v.isValid);

      console.log(`Found ${truePositives.length} true positives out of ${vulnerabilities.length} total`);
      console.log(`Filtered ${response.data.stats.rejected} false positives`);

      return truePositives;
    }

    // Example usage
    const vulns = [
      {
        id: 'vuln_001',
        type: 'sql_injection',
        severity: 'high',
        file: 'src/db.js',
        line: 42,
        code: "db.query('SELECT * FROM users WHERE id = ' + userId)",
        message: 'SQL injection via string concatenation'
      }
    ];

    const files = {
      'src/db.js': fs.readFileSync('src/db.js', 'utf-8')
    };

    const validated = await validateVulnerabilities(vulns, files, process.env.API_KEY);
    ```

    ### Python
    ```python
    import requests
    from typing import List, Dict

    def validate_vulnerabilities(
        vulnerabilities: List[Dict],
        files: Dict[str, str],
        api_key: str
    ) -> List[Dict]:
        response = requests.post(
            'https://api.rsolv.dev/api/v1/vulnerabilities/validate',
            json={
                'vulnerabilities': [
                    {
                        'id': v['id'],
                        'type': v['type'],
                        'severity': v['severity'],
                        'file': v['file'],
                        'line': v['line'],
                        'code': v['code'],
                        'message': v['message']
                    }
                    for v in vulnerabilities
                ],
                'files': files
            },
            headers={
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }
        )

        data = response.json()

        # Filter to only true positives
        true_positives = [v for v in data['validated'] if v['isValid']]

        print(f"Found {len(true_positives)} true positives out of {len(vulnerabilities)} total")
        print(f"Filtered {data['stats']['rejected']} false positives")

        return true_positives

    # Example usage
    vulns = [
        {
            'id': 'vuln_001',
            'type': 'sql_injection',
            'severity': 'high',
            'file': 'app/db.py',
            'line': 42,
            'code': "cursor.execute(f'SELECT * FROM users WHERE id = {user_id}')",
            'message': 'SQL injection via f-string'
        }
    ]

    with open('app/db.py') as f:
        files = {'app/db.py': f.read()}

    validated = validate_vulnerabilities(vulns, files, os.environ['API_KEY'])
    ```

    ### cURL
    ```bash
    curl -X POST https://api.rsolv.dev/api/v1/vulnerabilities/validate \\
      -H "Authorization: Bearer $API_KEY" \\
      -H "Content-Type: application/json" \\
      -d '{
        "vulnerabilities": [{
          "id": "vuln_001",
          "type": "sql_injection",
          "severity": "high",
          "file": "src/user.js",
          "line": 42,
          "code": "const query = '\"'\"'SELECT * FROM users WHERE id = '\"'\"' + userId;",
          "message": "SQL query built using string concatenation"
        }],
        "files": {
          "src/user.js": "const userId = req.params.id;\\nconst query = '\"'\"'SELECT * FROM users WHERE id = '\"'\"' + userId;\\ndb.query(query);"
        }
      }'
    ```

    ## Common Scenarios

    ### Scenario 1: True Positive (High Confidence)
    - User input flows directly to dangerous sink (e.g., SQL query, eval)
    - No validation or sanitization detected
    - Source file classification (not test/vendor)
    - Expected result: `isValid: true`, `confidence: 0.9-1.5`

    ### Scenario 2: False Positive (Test File)
    - Vulnerability detected in test file
    - File path contains 'test/', 'spec/', '__tests__'
    - Expected result: `isValid: false`, `confidence: 0.0-0.3`, `reason: "Test file"`

    ### Scenario 3: False Positive (Safe Pattern Detected)
    - Code uses parameterized queries or prepared statements
    - Input validation/sanitization detected
    - Expected result: `isValid: false`, `confidence: 0.1-0.4`, `reason: "Safe pattern detected"`

    ### Scenario 4: Medium Confidence
    - Indirect data flow (not direct user input)
    - Some validation present but incomplete
    - Expected result: `isValid: true`, `confidence: 0.5-0.7`
    """
    require OpenApiSpex

    OpenApiSpex.schema(%{
      title: "VulnerabilityValidateRequest",
      description: "Request to validate detected vulnerabilities using AST analysis",
      type: :object,
      properties: %{
        vulnerabilities: %Schema{
          type: :array,
          items: %Schema{
            type: :object,
            properties: %{
              id: %Schema{
                type: :string,
                description: "Unique identifier for this vulnerability",
                example: "vuln_001"
              },
              type: %Schema{
                type: :string,
                description: "Vulnerability type",
                example: "sql_injection"
              },
              severity: %Schema{
                type: :string,
                enum: ["critical", "high", "medium", "low"],
                example: "high"
              },
              file: %Schema{
                type: :string,
                description: "File path",
                example: "src/controllers/user.js"
              },
              line: %Schema{
                type: :integer,
                description: "Line number (1-based or 0-based)",
                example: 42
              },
              code: %Schema{
                type: :string,
                description: "The vulnerable code snippet",
                example: "const query = 'SELECT * FROM users WHERE id = ' + userId;"
              },
              message: %Schema{
                type: :string,
                description: "Description of the vulnerability",
                example: "SQL query built using string concatenation"
              }
            },
            required: [:id, :type, :file, :code]
          },
          description: "Array of vulnerabilities to validate",
          minItems: 1
        },
        files: %Schema{
          type: :object,
          description: "Optional map of file paths to file content for context",
          additionalProperties: %Schema{
            oneOf: [
              %Schema{type: :string, description: "File content as string"},
              %Schema{
                type: :object,
                properties: %{
                  content: %Schema{type: :string, description: "File content"}
                }
              }
            ]
          },
          example: %{
            "src/controllers/user.js" =>
              "const userId = req.params.id;\nconst query = 'SELECT * FROM users WHERE id = ' + userId;"
          }
        },
        repository: %Schema{
          type: :string,
          description: "Repository identifier for cache scoping (e.g., 'org/repo')",
          example: "myorg/myrepo"
        }
      },
      required: [:vulnerabilities],
      example: %{
        "vulnerabilities" => [
          %{
            "id" => "vuln_001",
            "type" => "sql_injection",
            "severity" => "high",
            "file" => "src/controllers/user.js",
            "line" => 42,
            "code" => "const query = 'SELECT * FROM users WHERE id = ' + userId;",
            "message" => "SQL query built using string concatenation"
          }
        ],
        "files" => %{
          "src/controllers/user.js" =>
            "const userId = req.params.id;\nconst query = 'SELECT * FROM users WHERE id = ' + userId;"
        }
      }
    })
  end

  defmodule VulnerabilityValidateResponse do
    @moduledoc "Vulnerability validation response with AST analysis results"
    require OpenApiSpex

    OpenApiSpex.schema(%{
      title: "VulnerabilityValidateResponse",
      description:
        "Results from AST-based vulnerability validation with false positive reduction",
      type: :object,
      properties: %{
        validated: %Schema{
          type: :array,
          items: %Schema{
            type: :object,
            properties: %{
              id: %Schema{
                type: :string,
                description: "Vulnerability identifier",
                example: "vuln_001"
              },
              isValid: %Schema{
                type: :boolean,
                description:
                  "Whether this is a true positive (false = filtered as false positive)",
                example: true
              },
              confidence: %Schema{
                type: :number,
                format: :float,
                description: "Confidence score (0.0 - 1.5, adjusted by file classification)",
                minimum: 0.0,
                maximum: 1.5,
                example: 0.95
              },
              reason: %Schema{
                type: :string,
                nullable: true,
                description: "Explanation if filtered as false positive",
                example: "Safe pattern detected: using parameterized query"
              },
              fromCache: %Schema{
                type: :boolean,
                description: "Whether result came from cache",
                example: false
              },
              astContext: %Schema{
                type: :object,
                description: "AST analysis context",
                properties: %{
                  inUserInputFlow: %Schema{
                    type: :boolean,
                    description: "Whether code is in user input data flow"
                  },
                  hasValidation: %Schema{
                    type: :boolean,
                    description: "Whether validation/sanitization detected"
                  },
                  fileClassification: %Schema{
                    type: :string,
                    enum: ["source", "test", "vendor", "config"],
                    description: "File path classification"
                  },
                  safePattern: %Schema{
                    type: :boolean,
                    description: "Whether a safe pattern was detected",
                    nullable: true
                  },
                  taintLevel: %Schema{
                    type: :string,
                    enum: ["none", "low", "medium", "high"],
                    description: "Taint analysis level",
                    nullable: true
                  },
                  taintConfidence: %Schema{
                    type: :number,
                    format: :float,
                    description: "Confidence from taint analysis",
                    nullable: true
                  }
                }
              }
            }
          },
          description: "Validated vulnerabilities with AST context"
        },
        stats: %Schema{
          type: :object,
          description: "Summary statistics",
          properties: %{
            total: %Schema{type: :integer, description: "Total vulnerabilities checked"},
            validated: %Schema{type: :integer, description: "True positives (isValid = true)"},
            rejected: %Schema{
              type: :integer,
              description: "False positives filtered (isValid = false)"
            }
          }
        },
        cache_stats: %Schema{
          type: :object,
          description: "Cache performance statistics",
          additionalProperties: true,
          example: %{
            "cache_hits" => 15,
            "cache_misses" => 3,
            "hit_rate" => 0.83
          }
        }
      },
      required: [:validated, :stats],
      example: %{
        "validated" => [
          %{
            "id" => "vuln_001",
            "isValid" => true,
            "confidence" => 0.95,
            "reason" => nil,
            "fromCache" => false,
            "astContext" => %{
              "inUserInputFlow" => true,
              "hasValidation" => false,
              "fileClassification" => "source",
              "taintLevel" => "high",
              "taintConfidence" => 0.95,
              "directInput" => true,
              "taintedFlow" => true
            }
          },
          %{
            "id" => "vuln_002",
            "isValid" => false,
            "confidence" => 0.1,
            "reason" => "Safe pattern detected: using parameterized query",
            "fromCache" => false,
            "astContext" => %{
              "inUserInputFlow" => false,
              "hasValidation" => true,
              "fileClassification" => "source",
              "safePattern" => true
            }
          }
        ],
        "stats" => %{
          "total" => 2,
          "validated" => 1,
          "rejected" => 1
        },
        "cache_stats" => %{
          "cache_hits" => 0,
          "cache_misses" => 2
        }
      }
    })
  end
end
