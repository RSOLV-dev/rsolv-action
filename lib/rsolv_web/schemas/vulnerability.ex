defmodule RsolvWeb.Schemas.Vulnerability do
  @moduledoc """
  OpenAPI schemas for vulnerability validation endpoints.
  """

  alias OpenApiSpex.Schema

  defmodule VulnerabilityValidateRequest do
    @moduledoc "Vulnerability validation request for AST-based false positive reduction"
    require OpenApiSpex

    OpenApiSpex.schema(%{
      title: "VulnerabilityValidateRequest",
      description: "Request to validate detected vulnerabilities using AST analysis",
      type: :object,
      properties: %{
        vulnerabilities: %Schema{
          type: :array,
          items: %Schema{
            type: :object,
            properties: %{
              id: %Schema{
                type: :string,
                description: "Unique identifier for this vulnerability",
                example: "vuln_001"
              },
              type: %Schema{
                type: :string,
                description: "Vulnerability type",
                example: "sql_injection"
              },
              severity: %Schema{
                type: :string,
                enum: ["critical", "high", "medium", "low"],
                example: "high"
              },
              file: %Schema{
                type: :string,
                description: "File path (can also use filePath or file_path)",
                example: "src/controllers/user.js"
              },
              line: %Schema{
                type: :integer,
                description: "Line number (1-based or 0-based)",
                example: 42
              },
              code: %Schema{
                type: :string,
                description: "The vulnerable code snippet",
                example: "const query = 'SELECT * FROM users WHERE id = ' + userId;"
              },
              message: %Schema{
                type: :string,
                description: "Description of the vulnerability",
                example: "SQL query built using string concatenation"
              }
            },
            required: [:id, :type, :file, :code]
          },
          description: "Array of vulnerabilities to validate",
          minItems: 1
        },
        files: %Schema{
          type: :object,
          description: "Optional map of file paths to file content for context",
          additionalProperties: %Schema{
            oneOf: [
              %Schema{type: :string, description: "File content as string"},
              %Schema{
                type: :object,
                properties: %{
                  content: %Schema{type: :string, description: "File content"}
                }
              }
            ]
          },
          example: %{
            "src/controllers/user.js" =>
              "const userId = req.params.id;\nconst query = 'SELECT * FROM users WHERE id = ' + userId;"
          }
        }
      },
      required: [:vulnerabilities],
      example: %{
        "vulnerabilities" => [
          %{
            "id" => "vuln_001",
            "type" => "sql_injection",
            "severity" => "high",
            "file" => "src/controllers/user.js",
            "line" => 42,
            "code" => "const query = 'SELECT * FROM users WHERE id = ' + userId;",
            "message" => "SQL query built using string concatenation"
          }
        ],
        "files" => %{
          "src/controllers/user.js" =>
            "const userId = req.params.id;\nconst query = 'SELECT * FROM users WHERE id = ' + userId;"
        }
      }
    })
  end

  defmodule VulnerabilityValidateResponse do
    @moduledoc "Vulnerability validation response with AST analysis results"
    require OpenApiSpex

    OpenApiSpex.schema(%{
      title: "VulnerabilityValidateResponse",
      description: "Results from AST-based vulnerability validation with false positive reduction",
      type: :object,
      properties: %{
        validated: %Schema{
          type: :array,
          items: %Schema{
            type: :object,
            properties: %{
              id: %Schema{
                type: :string,
                description: "Vulnerability identifier",
                example: "vuln_001"
              },
              isValid: %Schema{
                type: :boolean,
                description: "Whether this is a true positive (false = filtered as false positive)",
                example: true
              },
              confidence: %Schema{
                type: :number,
                format: :float,
                description: "Confidence score (0.0 - 1.5, adjusted by file classification)",
                minimum: 0.0,
                maximum: 1.5,
                example: 0.95
              },
              reason: %Schema{
                type: :string,
                nullable: true,
                description: "Explanation if filtered as false positive",
                example: "Safe pattern detected: using parameterized query"
              },
              fromCache: %Schema{
                type: :boolean,
                description: "Whether result came from cache",
                example: false
              },
              astContext: %Schema{
                type: :object,
                description: "AST analysis context",
                properties: %{
                  inUserInputFlow: %Schema{
                    type: :boolean,
                    description: "Whether code is in user input data flow"
                  },
                  hasValidation: %Schema{
                    type: :boolean,
                    description: "Whether validation/sanitization detected"
                  },
                  fileClassification: %Schema{
                    type: :string,
                    enum: ["source", "test", "vendor", "config"],
                    description: "File path classification"
                  },
                  safePattern: %Schema{
                    type: :boolean,
                    description: "Whether a safe pattern was detected",
                    nullable: true
                  },
                  taintLevel: %Schema{
                    type: :string,
                    enum: ["none", "low", "medium", "high"],
                    description: "Taint analysis level",
                    nullable: true
                  },
                  taintConfidence: %Schema{
                    type: :number,
                    format: :float,
                    description: "Confidence from taint analysis",
                    nullable: true
                  }
                }
              }
            }
          },
          description: "Validated vulnerabilities with AST context"
        },
        stats: %Schema{
          type: :object,
          description: "Summary statistics",
          properties: %{
            total: %Schema{type: :integer, description: "Total vulnerabilities checked"},
            validated: %Schema{type: :integer, description: "True positives (isValid = true)"},
            rejected: %Schema{
              type: :integer,
              description: "False positives filtered (isValid = false)"
            }
          }
        },
        cache_stats: %Schema{
          type: :object,
          description: "Cache performance statistics",
          additionalProperties: true,
          example: %{
            "cache_hits" => 15,
            "cache_misses" => 3,
            "hit_rate" => 0.83
          }
        }
      },
      required: [:validated, :stats],
      example: %{
        "validated" => [
          %{
            "id" => "vuln_001",
            "isValid" => true,
            "confidence" => 0.95,
            "reason" => nil,
            "fromCache" => false,
            "astContext" => %{
              "inUserInputFlow" => true,
              "hasValidation" => false,
              "fileClassification" => "source",
              "taintLevel" => "high",
              "taintConfidence" => 0.95,
              "directInput" => true,
              "taintedFlow" => true
            }
          },
          %{
            "id" => "vuln_002",
            "isValid" => false,
            "confidence" => 0.1,
            "reason" => "Safe pattern detected: using parameterized query",
            "fromCache" => false,
            "astContext" => %{
              "inUserInputFlow" => false,
              "hasValidation" => true,
              "fileClassification" => "source",
              "safePattern" => true
            }
          }
        ],
        "stats" => %{
          "total" => 2,
          "validated" => 1,
          "rejected" => 1
        },
        "cache_stats" => %{
          "cache_hits" => 0,
          "cache_misses" => 2
        }
      }
    })
  end
end
