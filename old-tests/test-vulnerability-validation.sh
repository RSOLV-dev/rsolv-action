#!/bin/bash
# Test RSOLV Vulnerability Validation API

set -euo pipefail

echo "========================================================="
echo "RSOLV Vulnerability Validation API Test"
echo "========================================================="

# Configuration
STAGING_URL="https://rsolv-staging.com"
API_KEY="rsolv_Nc4KkUwhoEtkKC2vZvrM8bINAY4t258qh8cYoam9hxE"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${BLUE}Testing vulnerability validation endpoint...${NC}"

# Create test code with SQL injection vulnerability
TEST_CODE=$(cat << 'EOF'
const express = require('express');
const app = express();

app.get('/user/:id', (req, res) => {
    const userId = req.params.id;
    const query = "SELECT * FROM users WHERE id = " + userId;
    db.query(query, (err, results) => {
        res.json(results);
    });
});
EOF
)

# Base64 encode the code
ENCODED_CODE=$(echo "$TEST_CODE" | base64 -w0)

# Create validation request
REQUEST_BODY=$(jq -n \
  --arg code "$ENCODED_CODE" \
  --arg lang "javascript" \
  '{
    "code": $code,
    "language": $lang,
    "vulnerabilities": [
      {
        "type": "sql_injection",
        "severity": "high",
        "line": 6,
        "column": 19,
        "message": "SQL Injection vulnerability detected",
        "pattern": "sql_concat_user_input"
      }
    ]
  }')

echo "Sending validation request..."
echo ""

# Call the validation API
RESPONSE=$(curl -s -X POST "$STAGING_URL/api/v1/vulnerabilities/validate" \
    -H "X-Api-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$REQUEST_BODY")

echo "Response:"
echo "$RESPONSE" | jq .

# Check if validation was successful
if echo "$RESPONSE" | jq -e '.validated_vulnerabilities' > /dev/null 2>&1; then
    echo ""
    echo -e "${GREEN}✅ Vulnerability validation successful!${NC}"

    TOTAL=$(echo "$RESPONSE" | jq '.summary.total_submitted // 0')
    VALID=$(echo "$RESPONSE" | jq '.summary.valid_count // 0')
    INVALID=$(echo "$RESPONSE" | jq '.summary.invalid_count // 0')

    echo ""
    echo "Summary:"
    echo "  - Total submitted: $TOTAL"
    echo "  - Valid vulnerabilities: $VALID"
    echo "  - Invalid (false positives): $INVALID"

    if [[ "$VALID" -gt 0 ]]; then
        echo ""
        echo -e "${YELLOW}Validated vulnerabilities:${NC}"
        echo "$RESPONSE" | jq -r '.validated_vulnerabilities[] | "  - Line \(.line): \(.type) (\(.severity))"'
    fi
elif echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    echo ""
    echo -e "${YELLOW}⚠️  API returned error: $ERROR${NC}"
else
    echo ""
    echo -e "${YELLOW}⚠️  Unexpected response format${NC}"
fi

echo ""
echo "========================================================="
echo "Test another vulnerability type: XSS"
echo "========================================================="

# Test XSS vulnerability
XSS_CODE=$(cat << 'EOF'
app.get('/search', (req, res) => {
    const searchTerm = req.query.q;
    res.send(`<h1>Search results for: ${searchTerm}</h1>`);
});
EOF
)

ENCODED_XSS=$(echo "$XSS_CODE" | base64 -w0)

XSS_REQUEST=$(jq -n \
  --arg code "$ENCODED_XSS" \
  --arg lang "javascript" \
  '{
    "code": $code,
    "language": $lang,
    "vulnerabilities": [
      {
        "type": "xss",
        "severity": "medium",
        "line": 3,
        "column": 5,
        "message": "Cross-site scripting vulnerability",
        "pattern": "xss_direct_response"
      }
    ]
  }')

echo "Testing XSS validation..."
XSS_RESPONSE=$(curl -s -X POST "$STAGING_URL/api/v1/vulnerabilities/validate" \
    -H "X-Api-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$XSS_REQUEST")

echo "$XSS_RESPONSE" | jq .

echo ""
echo "========================================================="
echo -e "${GREEN}✅ Vulnerability Validation API Test Complete${NC}"
echo "========================================================="