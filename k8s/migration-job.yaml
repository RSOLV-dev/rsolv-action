apiVersion: batch/v1
kind: Job
metadata:
  name: rsolv-api-migrate
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      imagePullSecrets:
      - name: ghcr-secret
      containers:
      - name: migrate
        image: ghcr.io/rsolv-dev/rsolv-api:latest
        imagePullPolicy: Always
        command: ["bin/rsolv_api", "eval", "RsolvApi.Release.migrate()"]
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: database-url
        - name: SECRET_KEY_BASE
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: secret-key-base
        - name: PHX_HOST
          value: "api.rsolv.dev"
        - name: PHX_SERVER
          value: "false"  # Don't start the web server