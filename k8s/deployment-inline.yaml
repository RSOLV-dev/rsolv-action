apiVersion: v1
kind: ConfigMap
metadata:
  name: rsolv-api-code
  namespace: default
data:
  simple-api.js: |
    // Simple production RSOLV API for quick deployment
    const express = require('express');
    const cors = require('cors');
    const crypto = require('crypto');

    const app = express();
    app.use(cors());
    app.use(express.json());

    // Environment variables
    const PORT = process.env.PORT || 3000;
    const MASTER_API_KEY = process.env.MASTER_API_KEY || 'rsolv_master_key_' + crypto.randomBytes(16).toString('hex');

    // AI Provider Keys (set these in environment)
    const AI_PROVIDERS = {
      anthropic: process.env.ANTHROPIC_API_KEY,
      openai: process.env.OPENAI_API_KEY,
      openrouter: process.env.OPENROUTER_API_KEY,
      ollama: 'no-key-needed'
    };

    // Simple in-memory store for API keys (in production, use a database)
    const API_KEYS = {
      // Pre-configured keys
      'rsolv_prod_demo_key': {
        customer_id: 'demo-customer',
        monthly_limit: 10,
        current_usage: 0,
        created_at: new Date()
      },
      'rsolv_dogfood_key': {
        customer_id: 'rsolv-internal',
        monthly_limit: 1000,
        current_usage: 0,
        created_at: new Date()
      }
    };

    console.log('=== RSOLV API Started ===');
    console.log('Available API Keys:');
    console.log('- rsolv_dogfood_key (internal use)');
    console.log('- rsolv_prod_demo_key (demos)');

    // Health check
    app.get('/health', (req, res) => {
      res.json({ 
        status: 'ok', 
        service: 'rsolv-api',
        version: '1.0.0',
        timestamp: new Date().toISOString()
      });
    });

    // Credential exchange
    app.post('/api/v1/credentials/exchange', (req, res) => {
      const { api_key, providers = ['anthropic'] } = req.body;
      
      if (!api_key || !API_KEYS[api_key]) {
        return res.status(401).json({ error: 'Invalid API key' });
      }
      
      const customer = API_KEYS[api_key];
      
      // Check usage limits
      if (customer.current_usage >= customer.monthly_limit) {
        return res.status(403).json({ error: 'Monthly usage limit exceeded' });
      }
      
      // Generate credentials
      const credentials = {};
      providers.forEach(provider => {
        if (AI_PROVIDERS[provider]) {
          credentials[provider] = {
            api_key: AI_PROVIDERS[provider],
            expires_at: new Date(Date.now() + 60 * 60 * 1000).toISOString() // 1 hour
          };
        }
      });
      
      res.json({
        credentials,
        usage: {
          remaining_fixes: customer.monthly_limit - customer.current_usage,
          reset_at: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString()
        }
      });
    });

    // Usage reporting
    app.post('/api/v1/usage/report', (req, res) => {
      const { api_key, tokens_used = 0 } = req.body;
      
      if (!api_key || !API_KEYS[api_key]) {
        return res.status(401).json({ error: 'Invalid API key' });
      }
      
      // Update usage (approximate 1 fix per 2000 tokens)
      const fixes_used = Math.ceil(tokens_used / 2000);
      API_KEYS[api_key].current_usage += fixes_used;
      
      console.log(`Usage reported: ${api_key} used ${tokens_used} tokens (${fixes_used} fixes)`);
      
      res.json({ status: 'recorded' });
    });

    app.listen(PORT, () => {
      console.log(`RSOLV API running on port ${PORT}`);
    });
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rsolv-api
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: rsolv-api
  template:
    metadata:
      labels:
        app: rsolv-api
    spec:
      containers:
      - name: rsolv-api
        image: node:18-alpine
        command: ["sh", "-c"]
        args: ["cd /tmp && npm install express cors && node /app/simple-api.js"]
        ports:
        - containerPort: 4000
        env:
        - name: PORT
          value: "4000"
        - name: NODE_ENV
          value: "production"
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: anthropic-api-key
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: openai-api-key
        - name: OPENROUTER_API_KEY
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: openrouter-api-key
        - name: MASTER_API_KEY
          valueFrom:
            secretKeyRef:
              name: rsolv-api-secrets
              key: secret-key-base
        volumeMounts:
        - name: api-code
          mountPath: /app
        livenessProbe:
          httpGet:
            path: /health
            port: 4000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 4000
          initialDelaySeconds: 20
          periodSeconds: 5
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: api-code
        configMap:
          name: rsolv-api-code
---
apiVersion: v1
kind: Service
metadata:
  name: rsolv-api
  namespace: default
spec:
  selector:
    app: rsolv-api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 4000
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rsolv-api-ingress
  namespace: default
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.rsolv.ai
    secretName: api-rsolv-ai-tls
  rules:
  - host: api.rsolv.ai
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rsolv-api
            port:
              number: 80