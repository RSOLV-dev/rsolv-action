# Webhook Identification Improvements

## Current Issues

1. **Fragile Text Matching**: Looking for exact string "Generated by RSOLV" when actual text varies
2. **Single Point of Failure**: Relying only on PR body content
3. **Platform Lock-in**: GitHub-specific patterns hardcoded
4. **Issue Reference Limitations**: Only supports `#123` format, not full URLs

## Implemented Improvements (github_handler_v2.ex)

### 1. Multiple Identification Methods
- **Labels**: Check for `rsolv:automated` label
- **Branch Pattern**: Check for `rsolv/` prefix
- **Title Pattern**: Check for `[RSOLV]` prefix
- **Body Patterns**: Multiple variations of RSOLV text
- **ANY match**: More flexible - any single method is sufficient

### 2. Enhanced Issue Reference Extraction
Supports multiple formats:
- `fixes #123` - Simple issue number
- `closes https://github.com/owner/repo/issues/456` - Full URL
- `resolves owner/repo#789` - Cross-repo reference
- Multiple keywords: fix, fixes, fixed, close, closes, closed, resolve, resolves, resolved

### 3. Metadata Capture
Stores additional context in the metadata field:
- Branch name
- Labels
- Created by (user)
- All issue references found

## Future Enhancements

### 1. API Key Association
```elixir
# When RSOLV action creates PR, it could include API key hash in metadata
metadata = %{
  api_key_hash: hash_api_key(config.api_key),
  rsolv_version: "1.0.0"
}
```

### 2. Webhook Secret per Customer
```elixir
# Different webhook URLs with embedded customer ID
POST /webhook/github/:customer_id
# Verify with customer-specific secret
```

### 3. PR Metadata Headers
```typescript
// In RSOLV action
await github.pulls.create({
  headers: {
    'X-RSOLV-Customer': customerId,
    'X-RSOLV-Version': version,
    'X-RSOLV-Signature': sign(prData, apiKey)
  }
});
```

### 4. Smart Pattern Learning
```elixir
# Track successful identifications
defmodule RsolvApi.Webhooks.PatternLearning do
  def track_identification(pr, method_used, success) do
    # Store patterns that successfully identified RSOLV PRs
    # Learn new patterns from confirmed RSOLV PRs
  end
end
```

### 5. Multi-Platform Support
```elixir
defmodule RsolvApi.Webhooks.PlatformAdapter do
  def extract_pr_info(:github, payload) do
    %{
      id: payload["pull_request"]["number"],
      title: payload["pull_request"]["title"],
      branch: payload["pull_request"]["head"]["ref"],
      labels: extract_labels(payload)
    }
  end
  
  def extract_pr_info(:gitlab, payload) do
    %{
      id: payload["object_attributes"]["iid"],
      title: payload["object_attributes"]["title"],
      branch: payload["object_attributes"]["source_branch"],
      labels: payload["labels"]
    }
  end
  
  def extract_pr_info(:jira, payload) do
    # Jira-specific extraction
  end
end
```

### 6. Confidence Scoring
```elixir
defp calculate_rsolv_confidence(pr) do
  score = 0
  score = if has_label?(pr, "rsolv:automated"), do: score + 40, else: score
  score = if has_branch_prefix?(pr, "rsolv/"), do: score + 30, else: score
  score = if has_title_prefix?(pr, "[RSOLV]"), do: score + 20, else: score
  score = if has_body_pattern?(pr), do: score + 10, else: score
  
  %{
    confidence: score,
    threshold: 30,  # Minimum score to consider it RSOLV
    is_rsolv: score >= 30
  }
end
```

## Migration Plan

1. **Phase 1**: Deploy V2 handler alongside V1
2. **Phase 2**: Monitor both handlers, compare results
3. **Phase 3**: Switch to V2 after validation
4. **Phase 4**: Add customer-specific identification
5. **Phase 5**: Implement pattern learning

## Testing Considerations

```elixir
# Test various PR formats
test "identifies RSOLV PR with only label" do
  pr = %{"labels" => [%{"name" => "rsolv:automated"}]}
  assert GitHubHandlerV2.is_rsolv_pr?(pr)
end

test "identifies RSOLV PR with only branch" do
  pr = %{"head" => %{"ref" => "rsolv/123-fix-bug"}}
  assert GitHubHandlerV2.is_rsolv_pr?(pr)
end

test "extracts GitHub URL issue reference" do
  refs = GitHubHandlerV2.extract_issue_references(
    "This fixes https://github.com/owner/repo/issues/123"
  )
  assert [%{type: :url, owner: "owner", repo: "repo", value: 123}] = refs
end
```