/**
 * Tests for Vulnerability Assertion Templates
 * RFC-103: RED Test Generation Quality Improvements
 *
 * Phase 2.3: Verifies behavioral test guidance (Tier 1/2)
 * Phase 2.4: Verifies framework conventions in hints
 */

import { describe, it, expect } from 'vitest';
import {
  getAssertionTemplate,
  getAssertionTemplateForFramework,
  SUPPORTED_CWES,
  AssertionTemplate
} from '../vulnerability-assertion-templates.js';

describe('VulnerabilityAssertionTemplates', () => {
  describe('getAssertionTemplate', () => {
    it('returns template for CWE-89 (SQL Injection)', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template).toBeDefined();
      expect(template?.name).toBe('SQL Injection');
      expect(template?.assertionGoal).toContain('mock the database layer');
      expect(template?.attackPayload).toBeDefined();
      expect(template?.attackPayload).toContain("'");
    });

    it('returns template for CWE-79 (XSS)', () => {
      const template = getAssertionTemplate('CWE-79');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Cross-Site Scripting (XSS)');
      expect(template?.assertionGoal).toContain('XSS payload');
      expect(template?.attackPayload).toContain('<script>');
    });

    it('returns template for CWE-22 (Path Traversal)', () => {
      const template = getAssertionTemplate('CWE-22');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Path Traversal');
      expect(template?.attackPayload).toContain('..');
    });

    it('returns template for CWE-78 (Command Injection)', () => {
      const template = getAssertionTemplate('CWE-78');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Command Injection');
      expect(template?.attackPayload).toContain(';');
    });

    it('returns template for CWE-502 (Deserialization)', () => {
      const template = getAssertionTemplate('CWE-502');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Insecure Deserialization');
    });

    it('returns template for CWE-1321 (Prototype Pollution)', () => {
      const template = getAssertionTemplate('CWE-1321');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Prototype Pollution');
      expect(template?.assertionGoal).toContain('__proto__');
      expect(template?.attackPayload).toContain('__proto__');
    });

    it('returns template for CWE-798 (Hardcoded Secrets)', () => {
      const template = getAssertionTemplate('CWE-798');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Hardcoded Credentials');
    });

    it('returns template for CWE-1336 (SSTI)', () => {
      const template = getAssertionTemplate('CWE-1336');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Server-Side Template Injection (SSTI)');
      expect(template?.attackPayload).toContain('{{7*7}}');
    });

    it('returns undefined for unknown CWE', () => {
      const template = getAssertionTemplate('CWE-99999');
      expect(template).toBeUndefined();
    });

    it('includes framework hints for all major frameworks', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints).toBeDefined();
      expect(template?.frameworkHints.rspec).toBeDefined();
      expect(template?.frameworkHints.pytest).toBeDefined();
      expect(template?.frameworkHints.mocha).toBeDefined();
      expect(template?.frameworkHints.exunit).toBeDefined();
      expect(template?.frameworkHints.phpunit).toBeDefined();
      expect(template?.frameworkHints.junit).toBeDefined();
    });

    it('includes test strategy with tier guidance for each template', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);
        expect(template?.testStrategy).toBeDefined();
        expect(template?.testStrategy.length).toBeGreaterThan(20);
        // Phase 2.3: All templates should include tiered strategy
        expect(template?.testStrategy).toContain('Tier 1');
        expect(template?.testStrategy).toContain('Tier 2');
      }
    });
  });

  describe('SUPPORTED_CWES', () => {
    it('supports all major vulnerability types', () => {
      const requiredCwes = ['CWE-89', 'CWE-79', 'CWE-22', 'CWE-78', 'CWE-502', 'CWE-798', 'CWE-1321', 'CWE-1336'];
      for (const cwe of requiredCwes) {
        expect(SUPPORTED_CWES).toContain(cwe);
        expect(getAssertionTemplate(cwe)).toBeDefined();
      }
    });

    it('returns an array of strings', () => {
      expect(Array.isArray(SUPPORTED_CWES)).toBe(true);
      expect(SUPPORTED_CWES.every(cwe => typeof cwe === 'string')).toBe(true);
      expect(SUPPORTED_CWES.length).toBeGreaterThanOrEqual(8);
    });
  });

  describe('template structure', () => {
    it('all templates have required fields', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);

        expect(template).toBeDefined();
        expect(typeof template?.name).toBe('string');
        expect(typeof template?.assertionGoal).toBe('string');
        expect(typeof template?.attackPayload).toBe('string');
        expect(typeof template?.testStrategy).toBe('string');
        expect(typeof template?.frameworkHints).toBe('object');
      }
    });

    it('framework hints cover all major test frameworks', () => {
      const requiredFrameworks = ['rspec', 'pytest', 'mocha', 'exunit', 'phpunit', 'junit'];

      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);

        for (const framework of requiredFrameworks) {
          expect(template?.frameworkHints[framework]).toBeDefined();
          expect(typeof template?.frameworkHints[framework]).toBe('string');
        }
      }
    });
  });

  describe('Phase 2.3: Behavioral test guidance', () => {
    it('assertion goals describe behavioral testing (not source scanning)', () => {
      const template89 = getAssertionTemplate('CWE-89');
      // Should mention importing/calling functions, not reading source files
      expect(template89?.assertionGoal).toContain('Import');
      expect(template89?.assertionGoal).toContain('mock');

      const template78 = getAssertionTemplate('CWE-78');
      expect(template78?.assertionGoal).toContain('Import');
      expect(template78?.assertionGoal).toContain('mock');
    });

    it('test strategies include PREFERRED Tier 1 (direct function call)', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);
        expect(template?.testStrategy).toContain('PREFERRED');
        expect(template?.testStrategy).toContain('Tier 1');
      }
    });

    it('test strategies include LAST RESORT Tier 3 (source analysis)', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);
        expect(template?.testStrategy).toContain('LAST RESORT');
        expect(template?.testStrategy).toContain('Tier 3');
      }
    });

    it('framework hints include BEHAVIORAL guidance', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.rspec).toContain('BEHAVIORAL');
      expect(template?.frameworkHints.pytest).toContain('BEHAVIORAL');
      expect(template?.frameworkHints.mocha).toContain('BEHAVIORAL');
    });
  });

  describe('Phase 2.4: Framework conventions', () => {
    it('rspec hints include betterspecs.org conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.rspec).toContain('betterspecs.org');
      expect(template?.frameworkHints.rspec).toContain('context');
      expect(template?.frameworkHints.rspec).toContain('expect()');
    });

    it('pytest hints include pytest conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.pytest).toContain('pytest conventions');
      expect(template?.frameworkHints.pytest).toContain('fixture');
    });

    it('mocha hints include mocha conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.mocha).toContain('Mocha/Vitest');
    });

    it('phpunit hints include PHPUnit conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.phpunit).toContain('PHPUnit conventions');
    });

    it('exunit hints include ExUnit conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.exunit).toContain('ExUnit conventions');
    });

    it('junit hints include JUnit conventions', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints.junit).toContain('JUnit 5');
    });
  });

  describe('getAssertionTemplateForFramework', () => {
    it('returns template with framework-specific hint for rspec', () => {
      const result = getAssertionTemplateForFramework('CWE-89', 'rspec');
      expect(result).toBeDefined();
      expect(result?.frameworkHint).toContain('betterspecs');
      expect(result?.frameworkHint).toContain('BEHAVIORAL');
    });

    it('falls back to mocha hint for unknown framework', () => {
      const result = getAssertionTemplateForFramework('CWE-89', 'unknown_framework');
      expect(result).toBeDefined();
      expect(result?.frameworkHint).toContain('Mocha/Vitest');
    });

    it('returns undefined for unknown CWE', () => {
      const result = getAssertionTemplateForFramework('CWE-99999', 'rspec');
      expect(result).toBeUndefined();
    });
  });
});
