/**
 * Tests for Vulnerability Assertion Templates
 * RFC-103: RED Test Generation Quality Improvements
 */

import { describe, it, expect } from 'vitest';
import {
  getAssertionTemplate,
  SUPPORTED_CWES,
  AssertionTemplate
} from '../vulnerability-assertion-templates.js';

describe('VulnerabilityAssertionTemplates', () => {
  describe('getAssertionTemplate', () => {
    it('returns template for CWE-89 (SQL Injection)', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template).toBeDefined();
      expect(template?.name).toBe('SQL Injection');
      expect(template?.assertionGoal).toContain('UNESCAPED');
      expect(template?.attackPayload).toBeDefined();
      expect(template?.attackPayload).toContain("'");
    });

    it('returns template for CWE-79 (XSS)', () => {
      const template = getAssertionTemplate('CWE-79');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Cross-Site Scripting (XSS)');
      expect(template?.assertionGoal).toMatch(/encoding|escap/i);
      expect(template?.attackPayload).toContain('<script>');
    });

    it('returns template for CWE-22 (Path Traversal)', () => {
      const template = getAssertionTemplate('CWE-22');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Path Traversal');
      expect(template?.attackPayload).toContain('..');
    });

    it('returns template for CWE-78 (Command Injection)', () => {
      const template = getAssertionTemplate('CWE-78');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Command Injection');
      expect(template?.attackPayload).toContain(';');
    });

    it('returns template for CWE-502 (Deserialization)', () => {
      const template = getAssertionTemplate('CWE-502');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Insecure Deserialization');
    });

    it('returns template for CWE-798 (Hardcoded Secrets)', () => {
      const template = getAssertionTemplate('CWE-798');
      expect(template).toBeDefined();
      expect(template?.name).toBe('Hardcoded Credentials');
    });

    it('returns undefined for unknown CWE', () => {
      const template = getAssertionTemplate('CWE-99999');
      expect(template).toBeUndefined();
    });

    it('includes framework hints when available', () => {
      const template = getAssertionTemplate('CWE-89');
      expect(template?.frameworkHints).toBeDefined();
      expect(template?.frameworkHints.rspec).toContain('stub');
      expect(template?.frameworkHints.pytest).toContain('mock');
      expect(template?.frameworkHints.mocha).toContain('sinon');
      expect(template?.frameworkHints.exunit).toBeDefined();
      expect(template?.frameworkHints.phpunit).toBeDefined();
      expect(template?.frameworkHints.junit).toBeDefined();
    });

    it('includes test strategy for each template', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);
        expect(template?.testStrategy).toBeDefined();
        expect(template?.testStrategy.length).toBeGreaterThan(20);
      }
    });
  });

  describe('SUPPORTED_CWES', () => {
    it('supports all major vulnerability types', () => {
      const requiredCwes = ['CWE-89', 'CWE-79', 'CWE-22', 'CWE-78', 'CWE-502', 'CWE-798'];
      for (const cwe of requiredCwes) {
        expect(SUPPORTED_CWES).toContain(cwe);
        expect(getAssertionTemplate(cwe)).toBeDefined();
      }
    });

    it('returns an array of strings', () => {
      expect(Array.isArray(SUPPORTED_CWES)).toBe(true);
      expect(SUPPORTED_CWES.every(cwe => typeof cwe === 'string')).toBe(true);
      expect(SUPPORTED_CWES.length).toBeGreaterThanOrEqual(6);
    });
  });

  describe('template structure', () => {
    it('all templates have required fields', () => {
      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);

        expect(template).toBeDefined();
        expect(typeof template?.name).toBe('string');
        expect(typeof template?.assertionGoal).toBe('string');
        expect(typeof template?.attackPayload).toBe('string');
        expect(typeof template?.testStrategy).toBe('string');
        expect(typeof template?.frameworkHints).toBe('object');
      }
    });

    it('framework hints cover all major test frameworks', () => {
      const requiredFrameworks = ['rspec', 'pytest', 'mocha', 'exunit', 'phpunit', 'junit'];

      for (const cweId of SUPPORTED_CWES) {
        const template = getAssertionTemplate(cweId);

        for (const framework of requiredFrameworks) {
          expect(template?.frameworkHints[framework]).toBeDefined();
          expect(typeof template?.frameworkHints[framework]).toBe('string');
        }
      }
    });
  });
});
