#!/usr/bin/env python3
import requests
import json
import sys

# Test AST Validation on STAGING
validation_payload = {
    "vulnerabilities": [
        {
            "id": "vuln-001",
            "type": "sql_injection",
            "filePath": "routes/users.js",
            "line": 7,
            "severity": "high"
        }
    ],
    "files": {
        "routes/users.js": {
            "content": "const query = 'SELECT * FROM users WHERE id = ' + userId;"
        }
    }
}

print("ğŸ§ª Testing AST Validation on STAGING")
print("=" * 50)

# Test on staging environment
response = requests.post(
    "https://staging.api.rsolv.dev/api/v1/vulnerabilities/validate",
    headers={
        "X-Api-Key": "rsolv_-1U3PpIl2T3wo3Nw5v9wB1EM-riNnBcloKtq_gveimc",
        "Content-Type": "application/json"
    },
    json=validation_payload,
    timeout=30
)

print(f"\nğŸ“¨ Response Status: {response.status_code}")

if response.status_code == 200:
    result = response.json()
    print("\nâœ… AST Validation Works on STAGING!")

    if "stats" in result:
        print(f"\nğŸ“Š Statistics:")
        print(f"  Total: {result['stats'].get('total', 0)}")
        print(f"  Validated: {result['stats'].get('validated', 0)}")
        print(f"  Rejected: {result['stats'].get('rejected', 0)}")

    if "validated" in result and result["validated"]:
        print(f"\nğŸ” Validated Vulnerabilities:")
        for vuln in result["validated"]:
            print(f"  - {vuln.get('id', 'unknown')}:")
            print(f"    Valid: {vuln.get('isValid', False)}")
            print(f"    Confidence: {vuln.get('confidence', 0)}")

    if "rejected" in result and result["rejected"]:
        print(f"\nâŒ Rejected Vulnerabilities:")
        for vuln in result["rejected"]:
            print(f"  - {vuln.get('id', 'unknown')}: {vuln.get('reason', 'no reason')}")

    print("\nğŸ‰ STAGING VALIDATION SUCCESSFUL!")
else:
    print(f"\nâŒ AST Validation Failed on STAGING")
    print(f"Response: {response.text}")
    sys.exit(1)