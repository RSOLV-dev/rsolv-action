name: RSOLV Demo for Act (Local Testing)
# This workflow is optimized for running with act locally

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: false
        default: 'scan'
        type: choice
        options:
          - scan
          - validate
          - mitigate
          - full

jobs:
  rsolv-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up environment
        run: |
          echo "Setting up demo environment..."
          # For act, we use default values since GitHub context is limited
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-RSOLV-dev/nodegoat-vulnerability-demo}" >> $GITHUB_ENV
          echo "GITHUB_ACTOR=${GITHUB_ACTOR:-demo-user}" >> $GITHUB_ENV
          echo "GITHUB_SHA=${GITHUB_SHA:-$(git rev-parse HEAD 2>/dev/null || echo 'abc123')}" >> $GITHUB_ENV
          echo "GITHUB_REF=${GITHUB_REF:-refs/heads/main}" >> $GITHUB_ENV

          # Create a demo issue for testing if needed
          if [ "${{ github.event.inputs.mode }}" = "mitigate" ] || [ "${{ github.event.inputs.mode }}" = "full" ]; then
            echo "DEMO_ISSUE_NUMBER=1" >> $GITHUB_ENV
          fi

      - name: Configure git
        run: |
          git config --global user.name "RSOLV Bot"
          git config --global user.email "bot@rsolv.dev"
          git config --global init.defaultBranch main

      - name: Run RSOLV Action (Local Docker)
        # Use the locally built Docker image instead of GitHub Action
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/github/workspace" \
            -v "/var/run/docker.sock:/var/run/docker.sock" \
            -e RSOLV_API_KEY="rsolv_f65acvz-xwVfGTje2CIXs2nVN0ZDUZ8ntwn10MlaPCE" \
            -e RSOLV_MODE="${{ github.event.inputs.mode }}" \
            -e RSOLV_API_URL="${RSOLV_API_URL:-https://api.rsolv.dev}" \
            -e GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            -e GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" \
            -e GITHUB_WORKSPACE="/github/workspace" \
            -e GITHUB_SHA="${GITHUB_SHA}" \
            -e GITHUB_REF="${GITHUB_REF}" \
            -e GITHUB_ACTOR="${GITHUB_ACTOR}" \
            -e RSOLV_DEMO_MODE="true" \
            -e RSOLV_ISSUE_NUMBER="${DEMO_ISSUE_NUMBER:-}" \
            -e RSOLV_ENABLE_SECURITY_ANALYSIS="true" \
            -e RSOLV_ENABLE_AST_VALIDATION="true" \
            -e RSOLV_USE_GIT_BASED_EDITING="true" \
            -e RSOLV_USE_STRUCTURED_PHASES="true" \
            -e RSOLV_MAX_ISSUES="3" \
            rsolv-action:local

      - name: Show results
        if: always()
        run: |
          echo "âœ… RSOLV ${{ github.event.inputs.mode }} phase completed!"

          # Check for created files/issues
          if [ -f scan-results.json ]; then
            echo "ðŸ“Š Scan results:"
            cat scan-results.json | jq '.' 2>/dev/null || cat scan-results.json
          fi

          # Show git diff for mitigate mode
          if [ "${{ github.event.inputs.mode }}" = "mitigate" ] || [ "${{ github.event.inputs.mode }}" = "full" ]; then
            echo "ðŸ“ Changes made:"
            git diff --stat
            git diff HEAD~1..HEAD 2>/dev/null || echo "No commits yet"
          fi