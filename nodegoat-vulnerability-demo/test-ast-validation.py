#!/usr/bin/env python3
import requests
import json
import sys

# Test AST Validation with proper format
validation_payload = {
    "vulnerabilities": [
        {
            "id": "vuln-1",
            "type": "sql-injection",
            "filePath": "routes/users.js",
            "line": 10,
            "code": "query = 'SELECT * FROM users WHERE id = ' + userId",
            "severity": "critical"
        }
    ],
    "files": {
        "routes/users.js": {
            "content": """const express = require('express');
const router = express.Router();

router.get('/user/:id', (req, res) => {
    const userId = req.params.id;
    // Vulnerable SQL injection
    const query = 'SELECT * FROM users WHERE id = ' + userId;
    db.query(query, (err, results) => {
        res.json(results);
    });
});

module.exports = router;"""
        }
    }
}

print("ğŸ“¤ Sending validation request...")
print(f"  Endpoint: https://api.rsolv.dev/api/v1/vulnerabilities/validate")
print(f"  Vulnerabilities: {len(validation_payload['vulnerabilities'])}")
print(f"  Files: {list(validation_payload['files'].keys())}")

try:
    response = requests.post(
        "https://api.rsolv.dev/api/v1/vulnerabilities/validate",
        headers={
            "X-Api-Key": "rsolv_-1U3PpIl2T3wo3Nw5v9wB1EM-riNnBcloKtq_gveimc",
            "Content-Type": "application/json"
        },
        json=validation_payload,
        timeout=30
    )

    print(f"\nğŸ“¨ Response Status: {response.status_code}")
    print(f"Headers: {dict(response.headers)}")

    if response.status_code == 200:
        result = response.json()
        print("\nâœ… AST Validation Works!")

        if "stats" in result:
            print(f"\nğŸ“Š Statistics:")
            print(f"  Total: {result['stats'].get('total', 0)}")
            print(f"  Validated: {result['stats'].get('validated', 0)}")
            print(f"  Rejected: {result['stats'].get('rejected', 0)}")

        if "validated" in result and result["validated"]:
            print(f"\nğŸ” Validated Vulnerabilities:")
            for vuln in result["validated"]:
                print(f"  - {vuln.get('id', 'unknown')}:")
                print(f"    Valid: {vuln.get('isValid', False)}")
                print(f"    Confidence: {vuln.get('confidence', 0)}")
                if 'astData' in vuln:
                    print(f"    AST Data: Present")

        if "rejected" in result and result["rejected"]:
            print(f"\nâŒ Rejected Vulnerabilities:")
            for vuln in result["rejected"]:
                print(f"  - {vuln.get('id', 'unknown')}: {vuln.get('reason', 'no reason')}")

    else:
        print(f"\nâŒ AST Validation Failed!")
        print(f"Response body: {response.text}")

        # Try to parse error JSON if possible
        try:
            error_data = response.json()
            print(f"\nError details: {json.dumps(error_data, indent=2)}")
        except:
            pass

except requests.exceptions.RequestException as e:
    print(f"\nâŒ Request failed: {e}")
    sys.exit(1)