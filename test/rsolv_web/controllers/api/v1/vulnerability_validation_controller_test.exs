defmodule RsolvWeb.Api.V1.VulnerabilityValidationControllerTest do
  use RsolvWeb.ConnCase, async: true
  import Rsolv.APITestHelpers

  setup do
    setup_api_auth()
  end

  describe "validate/2" do
    test "requires API key authentication", %{conn: conn} do
      conn = post(conn, "/api/v1/vulnerabilities/validate", %{})

      response = json_response(conn, 401)
      assert response["error"]["code"] == "AUTH_REQUIRED"
      assert response["error"]["message"] =~ "API key must be provided"
      assert response["requestId"]
    end

    test "validates vulnerabilities using AST analysis", %{conn: conn, raw_api_key: raw_api_key} do
      # Test data with a real eval vulnerability
      request_data = %{
        "vulnerabilities" => [
          %{
            "id" => "vuln-123",
            "type" => "eval_injection",
            "file" => "app/routes/contributions.js",
            "line" => 32,
            "code" => "const preTax = eval(req.body.preTax);",
            "severity" => "critical"
          }
        ],
        "files" => %{
          "app/routes/contributions.js" => """
          const express = require('express');
          const router = express.Router();

          router.post('/calculate', (req, res) => {
            // Line 32: Unsafe eval with user input
            const preTax = eval(req.body.preTax);
            const afterTax = preTax * 0.9;
            res.json({ afterTax });
          });

          module.exports = router;
          """
        }
      }

      conn =
        conn
        |> put_req_header("x-api-key", raw_api_key)
        |> put_req_header("content-type", "application/json")
        |> post("/api/v1/vulnerabilities/validate", request_data)

      response = json_response(conn, 200)

      # Assert the structure
      assert Map.has_key?(response, "validated")
      assert Map.has_key?(response, "stats")

      # Check validation results
      assert length(response["validated"]) == 1
      validated = hd(response["validated"])

      assert validated["id"] == "vuln-123"
      assert validated["isValid"] == true
      assert validated["confidence"] >= 0.9
      assert validated["astContext"]["inUserInputFlow"] == true
      assert validated["astContext"]["hasValidation"] == false

      # Check stats
      assert response["stats"]["total"] == 1
      assert response["stats"]["validated"] == 1
      assert response["stats"]["rejected"] == 0
    end

    test "rejects false positives", %{conn: conn, raw_api_key: raw_api_key} do
      # Test data with eval in a comment (false positive)
      request_data = %{
        "vulnerabilities" => [
          %{
            "id" => "vuln-456",
            "type" => "js-eval-injection",
            "file" => "app/utils/safe.js",
            "line" => 2,
            "code" => "// Don't use eval() - it's dangerous",
            "severity" => "critical"
          }
        ],
        "files" => %{
          "app/utils/safe.js" => """
          const safeCalculate = (expression) => {
            // Don't use eval() - it's dangerous
            // Instead use a safe math parser
            return mathParser.evaluate(expression);
          };
          """
        }
      }

      conn =
        conn
        |> put_req_header("x-api-key", raw_api_key)
        |> put_req_header("content-type", "application/json")
        |> post("/api/v1/vulnerabilities/validate", request_data)

      response = json_response(conn, 200)

      # Check that the false positive was rejected
      assert length(response["validated"]) == 1
      validated = hd(response["validated"])

      assert validated["id"] == "vuln-456"
      assert validated["isValid"] == false
      assert validated["confidence"] <= 0.1
      assert validated["reason"] =~ "comment"

      # Check stats
      assert response["stats"]["total"] == 1
      assert response["stats"]["validated"] == 0
      assert response["stats"]["rejected"] == 1
    end

    test "handles multiple vulnerabilities in batch", %{conn: conn, raw_api_key: raw_api_key} do
      request_data = %{
        "vulnerabilities" => [
          %{
            "id" => "vuln-1",
            "type" => "js-eval-injection",
            "file" => "file1.js",
            "line" => 1,
            "code" => "eval(userInput)",
            "severity" => "critical"
          },
          %{
            "id" => "vuln-2",
            "type" => "js-eval-injection",
            "file" => "file2.js",
            "line" => 1,
            "code" => "const safe = 'eval is bad'",
            "severity" => "critical"
          }
        ],
        "files" => %{
          "file1.js" => "function process(userInput) { return eval(userInput); }",
          "file2.js" => "const safe = 'eval is bad'; // This is just a string"
        }
      }

      conn =
        conn
        |> put_req_header("x-api-key", raw_api_key)
        |> put_req_header("content-type", "application/json")
        |> post("/api/v1/vulnerabilities/validate", request_data)

      response = json_response(conn, 200)

      assert length(response["validated"]) == 2
      assert response["stats"]["total"] == 2
      assert response["stats"]["validated"] == 1
      assert response["stats"]["rejected"] == 1
    end

    test "handles missing file content gracefully", %{conn: conn, raw_api_key: raw_api_key} do
      request_data = %{
        "vulnerabilities" => [
          %{
            "id" => "vuln-789",
            "type" => "js-eval-injection",
            "file" => "missing.js",
            "line" => 10,
            "code" => "eval(x)",
            "severity" => "critical"
          }
        ],
        "files" => %{}
      }

      conn =
        conn
        |> put_req_header("x-api-key", raw_api_key)
        |> put_req_header("content-type", "application/json")
        |> post("/api/v1/vulnerabilities/validate", request_data)

      response = json_response(conn, 200)

      # Should skip validation when file content is missing
      validated = hd(response["validated"])
      assert validated["id"] == "vuln-789"
      # Defaults to true when can't validate
      assert validated["isValid"] == true
      assert validated["reason"] =~ "content unavailable"
    end
  end
end
