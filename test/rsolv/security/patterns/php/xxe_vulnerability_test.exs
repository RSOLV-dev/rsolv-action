defmodule Rsolv.Security.Patterns.Php.XxeVulnerabilityTest do
  use ExUnit.Case, async: true
  
  alias Rsolv.Security.Patterns.Php.XxeVulnerability
  alias Rsolv.Security.Pattern
  
  describe "pattern/0" do
    test "returns a valid pattern struct" do
      pattern = XxeVulnerability.pattern()
      
      assert %Pattern{} = pattern
      assert pattern.id == "php-xxe-vulnerability"
      assert pattern.name == "XML External Entity (XXE) Vulnerability"
      assert pattern.severity == :high
      assert pattern.type == :xxe
      assert pattern.languages == ["php"]
    end
    
    test "includes CWE and OWASP references" do
      pattern = XxeVulnerability.pattern()
      
      assert pattern.cwe_id == "CWE-611"
      assert pattern.owasp_category == "A05:2021"
    end
  end
  
  describe "regex matching" do
    setup do
      pattern = XxeVulnerability.pattern()
      {:ok, pattern: pattern}
    end
    
    test "matches simplexml_load_string with user input", %{pattern: pattern} do
      vulnerable_code = [
        ~S|$xml = simplexml_load_string($_POST['xml']);|,
        ~S|$data = simplexml_load_string($_GET['data']);|,
        ~S|$config = simplexml_load_string($_REQUEST['config']);|,
        ~S|$result = simplexml_load_string($_COOKIE['xml_data']);|,
        ~S|simplexml_load_string($_POST['content']);|
      ]
      
      for code <- vulnerable_code do
        assert Regex.match?(pattern.regex, code),
               "Should match: #{code}"
      end
    end
    
    test "matches DOMDocument loadXML with user input", %{pattern: pattern} do
      vulnerable_code = [
        ~S|$dom = new DOMDocument(); $dom->loadXML($_POST['xml']);|,
        ~S|$doc->loadXML($_GET['data']);|,
        ~S|$parser->loadXML($_REQUEST['content']);|,
        ~S|$document->loadXML($_COOKIE['xml']);|
      ]
      
      for code <- vulnerable_code do
        assert Regex.match?(pattern.regex, code),
               "Should match: #{code}"
      end
    end
    
    test "matches various spacing and formatting", %{pattern: pattern} do
      vulnerable_code = [
        ~S|simplexml_load_string( $_POST['xml'] );|,
        ~S|$dom->loadXML(  $_GET['data']  );|,
        ~S|simplexml_load_string($_REQUEST['content']);|,
        ~S|$result=simplexml_load_string($_POST['xml']);|
      ]
      
      for code <- vulnerable_code do
        assert Regex.match?(pattern.regex, code),
               "Should match: #{code}"
      end
    end
    
    test "does not match safe XML processing", %{pattern: pattern} do
      safe_code = [
        ~S|$xml = simplexml_load_string($safe_data);|,
        ~S|$dom->loadXML($internal_xml);|,
        ~S|$xml = simplexml_load_string($validated_input, 'SimpleXMLElement', LIBXML_NOCDATA);|,
        ~S|$data = json_decode($_POST['data'], true);|
      ]
      
      for code <- safe_code do
        refute Regex.match?(pattern.regex, code),
               "Should not match: #{code}"
      end
    end
    
    test "matches real-world vulnerable patterns", %{pattern: pattern} do
      vulnerable_code = [
        ~S|$xml = simplexml_load_string($_FILES['upload']['content']);|,
        ~S|$import_data = simplexml_load_string($_POST['xml_import']);|,
        ~S|$config = new DOMDocument(); $config->loadXML($_GET['settings']);|,
        ~S|$parser = new DOMDocument(); $result = $parser->loadXML($_REQUEST['document']);|
      ]
      
      for code <- vulnerable_code do
        assert Regex.match?(pattern.regex, code),
               "Should match: #{code}"
      end
    end
  end
  
  describe "test_cases/0" do
    test "all positive cases match" do
      pattern = XxeVulnerability.pattern()
      test_cases = XxeVulnerability.test_cases()
      
      for test_case <- test_cases.positive do
        assert Regex.match?(pattern.regex, test_case.code),
               "Failed to match positive case: #{test_case.description}"
      end
    end
    
    test "negative cases are documented correctly" do
      test_cases = XxeVulnerability.test_cases()
      
      assert length(test_cases.negative) > 0
      
      for test_case <- test_cases.negative do
        assert Map.has_key?(test_case, :code)
        assert Map.has_key?(test_case, :description)
      end
    end
  end
  
  describe "ast_enhancement/0" do
    test "returns proper enhancement rules" do
      enhancement = XxeVulnerability.ast_enhancement()
      
      assert enhancement.min_confidence >= 0.7
      assert length(enhancement.ast_rules) >= 3
      
      xml_functions_rule = Enum.find(enhancement.ast_rules, &(&1.type == "xml_parsing_functions"))
      assert xml_functions_rule
      assert "simplexml_load_string" in xml_functions_rule.functions
      assert "loadXML" in xml_functions_rule.functions
      
      mitigation_rule = Enum.find(enhancement.ast_rules, &(&1.type == "xxe_mitigation"))
      assert mitigation_rule
      assert "libxml_disable_entity_loader" in mitigation_rule.functions
    end
  end
  
  describe "pattern metadata" do
    test "has proper OWASP reference" do
      pattern = XxeVulnerability.pattern()
      assert pattern.owasp_category == "A05:2021"
    end
    
    test "has educational content" do
      desc = XxeVulnerability.vulnerability_description()
      assert desc =~ "external entity"
      assert desc =~ "XML"
      assert desc =~ "file disclosure"
    end
    
    test "provides safe alternatives" do
      examples = XxeVulnerability.examples()
      assert Map.has_key?(examples.fixed, "Disable external entities")
      assert Map.has_key?(examples.fixed, "Use JSON instead")
    end
  end
end